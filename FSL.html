<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta name="generator" content="jemdoc, see http://jemdoc.jaboc.net/" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" href="jemdoc.css" type="text/css" />
<title>A Quick Guide to FSL</title>
<!-- MathJax -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async>
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
	  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
<!-- End MathJax -->
</head>
<body>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
    var pageTracker = _gat._getTracker("UA-252546838-1");
    pageTracker._trackPageview();
} catch(err) {}</script>
<table summary="Table for page layout." id="tlayout">
<tr valign="top">
<td id="layout-menu">
<div class="menu-category">Home</div>
<div class="menu-item"><a href="sws_intro.html">Intro</a></div>
<div class="menu-item"><a href="index.html">Homepage</a></div>
<div class="menu-category">Software</div>
<div class="menu-item"><a href="freesurfer.html">FreeSurfer</a></div>
<div class="menu-item"><a href="ants.html">ANTs</a></div>
<div class="menu-item"><a href="MRtrix.html">MRtrix</a></div>
<div class="menu-item"><a href="afni.html">AFNI</a></div>
<div class="menu-item"><a href="FSL.html" class="current">FSL</a></div>
<div class="menu-category">Data</div>
<div class="menu-item"><a href="dataOverview.html">Overview</a></div>
<div class="menu-item"><a href="HCP.html">HCP</a></div>
</td>
<td id="layout-content">
<div id="toptitle">
<h1>A Quick Guide to FSL</h1>
</div>
<h2>Installation on macOS</h2>
<p>FSL provides introductory courses with hands-on tutorials which can be accessed through this <a href="https://open.win.ox.ac.uk/pages/fslcourse/website/online_materials.html" target=&ldquo;blank&rdquo;>link</a>.
</p>
<h2>Structural MRI</h2>
<h3>Image Preprocessing</h3>
<p>Registration (<a href="https://open.win.ox.ac.uk/pages/fslcourse/practicals/registration/index.html" target=&ldquo;blank&rdquo;>official tutorial</a>): This contains two main steps:
</p>
<ul>
<li><p>Register functional EPI images to the individual structural image and to standard space using FEAT. This includes fieldmap-based unwarping and the preparation of these fieldmap scans.
</p>
</li>
<li><p>Calculate and apply transforms and inverses from linear and non-linear registration
</p>
</li>
</ul>
<p>Segmentation (<a href="https://open.win.ox.ac.uk/pages/fslcourse/practicals/seg_struc/index.html" target=&ldquo;blank&rdquo;>official tutorial</a>): This includes using FAST (tissue-type segmentation), FIRST (sub-cortical structure segmentation) and FSL-VBM (local grey matter volume difference analysis).
</p>
<h3>ROI</h3>
<h2>rs-fMRI</h2>
<p>For each single subject, to extract the time series from a 4D (3D structural + 1D time) NIFTI file for <b>ONE</b> ROI, use <tt>fslmeants</tt>, which average the time series over all voxels in the mask to obtain one final time series.
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
fslmeants -i &lt;fMRI input&gt;.nii.gz -o &lt;output name&gt;.txt -m &lt;roi mask&gt;.nii.gz
</pre></div></div>
<h2>t-fMRI</h2>
<h3>Running FEAT through GUI</h3>
<p>To open the Feat GUI, go to the target directory (that contains nifti and other files) and call the following command in the Terminal.
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
feat_gui
</pre></div></div>
<p>Prepare the following files for input:
</p>
<ul>
<li><p>4D image (in NIFTI format). In the first-level analysis, we only need one of the sessions.
</p>
</li>
<li><p>waveform txt files for the tasks (3 columns)
</p>
</li>
</ul>
<table class="imgtable"><tr><td>
<img src="./figs/FSL_FEAT_GUI.png" alt="" width="60%" />&nbsp;</td>
<td align="left"></td></tr></table>
<h3>Scripting</h3>
<p>All the operations in the FEAT GUI can be transformed into a <tt>.fsf</tt> file (a txt file actually). The following is an snippet from HCP t-fMRI dataset (tfMRI_LANGUAGE_LR_hp200_s4_level1.fsf):
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
# FEAT version number
set fmri(version) 6.00

# Are we in MELODIC?
set fmri(inmelodic) 0

# Analysis level
# 1 : First-level analysis
# 2 : Higher-level analysis
set fmri(level) 1

# Which stages to run
# 0 : No first-level analysis (registration and/or group stats only)
# 7 : Full first-level analysis
# 1 : Pre-Stats
# 3 : Pre-Stats + Stats
# 2 :             Stats
# 6 :             Stats + Post-stats
# 4 :                     Post-stats
set fmri(analysis) 7

(...and much more)
</pre></div></div>
<p>You don't need to write it yourself. Just go to the GUI, finish the settings and click <tt>save</tt>. It will generate the fsf file for you.
</p>
<p>After having the fsf file, to run this pipeline without opening the GUI, use
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
feat &lt;name&gt;.fsf
</pre></div></div>
<p>For more information about scripting to run on all subjects, you can see <a href="https://andysbrainbook.readthedocs.io/en/latest/fMRI_Short_Course/fMRI_06_Scripting.html" target=&ldquo;blank&rdquo;>this tutorial</a>.
</p>
<h3>Reading the output</h3>
<p>For a complete list of what each output file is about, see <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#FEAT_Output" target=&ldquo;blank&rdquo;>official tutorial</a>. We may be interested in:
</p>
<ul>
<li><p><b>filtered_func_data.nii.gz</b>: the 4D FMRI data after all filtering.
</p>
</li>
<li><p><b>stats/pe1.nii.gz</b> or <b>stats/pe2.nii.gz</b> etc.: the original parameter estimate image for EV 1, EV 2, etc.
</p>
<ul>
<li><p>Note: <b>stats/cope1.nii.gz</b> and  <b>stats/pe1.nii.gz</b> are identical. You can check this in MATLAB. So you can use either one of them.
</p>
</li>
<li><p><b>stats/tstat1.nii.gz</b> or <b>stats/tstat2.nii.gz</b>: T statistic image for contrast 1 (=cope/sqrt(varcope)).
</p>
</li>
</ul>

</li>
</ul>
<h2>DWI</h2>
<p>The main toolbox is <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide" target=&ldquo;blank&rdquo;>FDT</a>.  The programs in this toolbox are: 
</p>
<ul>
<li><p><tt>eddy</tt> - for correction of eddy current distortions 
</p>
</li>
<li><p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide#BEDPOSTX" target=&ldquo;blank&rdquo;>bedpostx</a> - for local modeling of diffusion parameters (creating all the files necessary for running prob tractography.)
</p>
</li>
<li><p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide#PROBTRACKX\_-\_probabilistic\_tracking\_with\_crossing\_fibres" target=&ldquo;blank&rdquo;>probtrackx</a> - for tractography and connectivity-based segmentation 
</p>
</li>
<li><p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide#DTIFIT" target=&ldquo;blank&rdquo;>dtifit</a> - for local fitting of diffusion tensors
</p>
</li>
</ul>
<p>The order of running all these procedures should be 
</p>
<ul>
<li><p>eddy - dtifit (see this <a href="https://open.win.ox.ac.uk/pages/fslcourse/practicals/fdt1/index.html" target=&ldquo;blank&rdquo;>official tutorial</a>) or
</p>
</li>
<li><p>eddy - bedpostx - probtrackx  (see this <a href="https://open.win.ox.ac.uk/pages/fslcourse/practicals/fdt2/index.html" target=&ldquo;blank&rdquo;>official tutorial</a>)
</p>
</li>
</ul>
<h3>Obtaining structural connectivity matrix</h3>
<p>So we are going the second way. Suppose you have the files prepared as follows:
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
/current directory
├── &lt;subjid&gt;
│   ├── data.nii.gz
|   ├── nodif_brain_mask.nii.gz
|   ├── bval
|   └── bvec
└── ...
</pre></div></div>
<p><tt>bedpostx</tt> creates a new directory at the same level as the input directory. So, after this step, you should expect
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
/current directory
├── &lt;subjid&gt;
|   └── ...
├── &lt;subjid&gt;.bedpostX
│   ├── logs
|   |   └── ...
│   ├── xfms
|   |   └── ...
|   ├── merged_*.nii.gz (Individual parameter estimates)
│   ├── mean_*.nii.gz (Mean parameter estimate)
│   ├── dyad*.nii.gz (Mean fibre orientations)
│   ├── dyad*_dispersion.nii.gz (Uncertainty in fibre orientation)
|   └── ...
└── ...
</pre></div></div>
<p>Some of these files are copies from the input directory. The most important files for next steps are <tt>merged_*.nii.gz</tt>. If for visualization purposes only, use <tt>mean_*.nii.gz</tt>.
</p>
<p>Then, to run <tt>probtrackx</tt>, use the following script (minimally, configurations, such as number of samples, are set as default)
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
probtrackx2 --network -x &lt;masks.txt&gt; \
            -l --onewaycondition --forcedir --opd \
            -s &lt;subjid.bedpostx path&gt;/merged \
            -m &lt;subjid.bedpostx path&gt;/nodif_brain_mask \
            --dir=&lt;output folder path&gt;
</pre></div></div>
<p>Here <tt>mask.txt</tt> is the list of ROI nifti files, in the format of:
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
/Users/zijianchen/Downloads/BN/BN1.nii
/Users/zijianchen/Downloads/BN/BN10.nii
/Users/zijianchen/Downloads/BN/BN100.nii
</pre></div></div>
<p>The output directory will have a file <tt>fdt_network_matrix</tt>, which is the \(N\times N\) connectivity matrix whose elements are the number of streamlines between the selected ROIs. It doesn't have an extension name but can still be imported into MATLAB using 
</p>
<div class="codeblock">
<div class="blockcontent"><pre>
M = load('fdt_network_matrix');
</pre></div></div>
<div id="footer">
<div id="footer-text">
Page generated 2024-02-19 23:59:29 EST.
</div>
</div>
</td>
</tr>
</table>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EZMPZ1N19T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EZMPZ1N19T');
</script>
</body>
</html>
