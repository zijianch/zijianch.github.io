<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta name="generator" content="jemdoc, see http://jemdoc.jaboc.net/" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" href="jemdoc.css" type="text/css" />
<title>Gradient Descent with Brenier's theorem</title>
<!-- MathJax -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async>
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
	  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
<!-- End MathJax -->
</head>
<body>
<table summary="Table for page layout." id="tlayout">
<tr valign="top">
<td id="layout-menu">
<div class="menu-category">Wasserstein Distance</div>
<div class="menu-item"><a href="wasserstein_index.html">Intro</a></div>
<div class="menu-category">Formulations</div>
<div class="menu-item"><a href="wasserstein_Monge.html">Monge</a></div>
<div class="menu-item"><a href="wasserstein_Kantorovich.html">Kantorovich</a></div>
<div class="menu-item"><a href="wasserstein_Relations.html">Relations</a></div>
<div class="menu-category">Solvers</div>
<div class="menu-item"><a href="wasserstein_explicit.html">Explicit&nbsp;solution</a></div>
<div class="menu-item"><a href="wasserstein_LP.html">Linear&nbsp;programming</a></div>
<div class="menu-item"><a href="wasserstein_GD1.html" class="current">GD&nbsp;with&nbsp;Brenier</a></div>
<div class="menu-item"><a href="wasserstein_GD2.html">GD&nbsp;with&nbsp;dual&nbsp;formulation</a></div>
<div class="menu-category">Applications</div>
<div class="menu-item"><a href="wasserstein_reg.html">Registration</a></div>
</td>
<td id="layout-content">
<div id="toptitle">
<h1>Gradient Descent with Brenier's theorem</h1>
</div>
<p>The key idea of this algorithm is that \(F=\nabla \phi(x)\) for some convex function \(\phi: X\to \mathbb{R}\) and thus \(F\) is <a href="https://en.wikipedia.org/wiki/Curl_(mathematics)#Identities" target=&ldquo;blank&rdquo;>curl-free</a>. The procedure begins with finding an arbitrary transport map (not necessarily optimal!), and repeating updating it so that it remains a transport map while reducing the curl and the distance. <font style="color:red">(Attention: transport map + curlfree \(\neq\) optimal map, that's why we also need to minimize the objective function, i.e., the distance)</font>
</p>
<h2>Algorithm</h2>
<h3>Step 1: Finding the initial transport map</h3>
<p>In this step, we need to map two probability measures. In fact, this is closely related to <a href="https://en.wikipedia.org/wiki/Coupling_(probability)" target=&ldquo;blank&rdquo;>couplings</a>, or to be more specific, deterministic couplings (for details, see <a href="https://cedricvillani.org/sites/dev/files/old_images/2012/08/preprint-1.pdf" target=&ldquo;blank&rdquo;>this book</a>). 
</p>
<p>The method is called &ldquo;Knothe-Rosenblatt rearrangement&rdquo;. It solves a family of one dimensional problems to Ô¨Ånd the \(n\)-dimensional solution. <u>To begin with</u>, we compute the marginals of the first variable, which we denote by \(\mu^{(1)}\) and \(\nu^{(1)}\) with densities
</p>
<p style="text-align:center">
\[
   I_0^{(1)}(x^{(1)}) =  \int_{-\infty}^{\infty} I_0(x^{(1)},x^{(2)}) \mathrm d x^{(1)}, \quad I_1^{(1)}(y^{(1)})=\int_{-\infty}^{\infty} I_1(y^{(1)},y^{(2)}) \mathrm d y^{(2)}.
\]
</p><p>Then we need to consider the optimal transport map between \(\mu^{(1)}\) and \(\nu^{(1)}\), which is a one-dimensional problem! We denote it as \(F_0^{(1)}\), then 
\((F_0^{(1)})_\# \mu^{(1)}=\nu^{(1)}\) can be written as
</p>
<p style="text-align:center">
\[
    \int_{-\infty}^{F_0^{(1)}(x^{(1)})} I_1^{(1)}(\eta) \mathrm d \eta =  \int_{-\infty}^{x^{(1)}} I_0^{(1)}(\eta) \mathrm d \eta , \quad \text{i.e.,}\quad \int_{-\infty}^{F_0^{(1)}(x^{(1)})} \int_{-\infty}^{\infty} I_1(\eta,y^{(2)}) \mathrm d y^{(2)} \mathrm d \eta =  \int_{-\infty}^{x^{(1)}}  \int_{-\infty}^{\infty} I_0(\eta,x^{(2)}) \mathrm d x^{(2)}  \mathrm d \eta.
\]
</p><p>We need to solve for \(F_0^{(1)}\) via this equation.
</p>
<p><u>In the next step</u>, we will consider the <a href="https://en.wikipedia.org/wiki/Disintegration_theorem" target=&ldquo;blank&rdquo;>disintegration</a> of the marginal of the first two variables (which is \(\mu\) and \(\nu\) in our \(\mathbb{R}^2\) case) with respect to \(\mu^{(1)}\) and \(\nu^{(1)}\). This will give us \(\mu^{(2)}(x^{(2)}|x^{(1)})\) and \(\nu^{(2)}(y^{(2)}|y^{(1)})\) with densities
</p>
<p style="text-align:center">
\[
I_0^{(2)}(x^{(2)}|x^{(1)})=\frac{I_0(x^{(1)},x^{(2)})}{I_0^{(1)}(x^{(1)})}, \quad I_1^{(2)}(y^{(2)}|y^{(1)})=\frac{I_1(y^{(1)},y^{(2)})}{I_1^{(1)}(y^{(1)})}.
\]
</p><p>Similarly, we need to consider the optimal transport map between \(\mu^{(2)}\) and \(\nu^{(2)}\). We denote it as \(F_0^{(2)}\), which can be solved through
</p>
<p style="text-align:center">
\[
\int_{-\infty}^{F_0^{(2)}(x^{(1)}, x^{(2)})} \int_{-\infty}^{F_0^{(1)}(x^{(1)})} I_1(y^{(1)}, y^{(2)}) \mathrm d y^{(1)} \mathrm d y^{(2)}=\int_{-\infty}^{x^{(2)}} \int_{-\infty}^{x^{(1)}} I_0(\eta, \tau) \mathrm d \eta \mathrm d \tau.
\]
</p><p>The <u>final solution</u> (for \(X,Y\subset \mathbb{R}^2\)) is given as
</p>
<p style="text-align:center">
\[
   \color{blue}{ F_0(x) = \begin{bmatrix}
        F_0^{(1)}(x^{(1)}) \\ F_0^{(2)}(x^{(1)},x^{(2)})
    \end{bmatrix}, \quad \text{for } x=(x^{(1)},x^{(2)})\in X. }
\]
</p><p>This process can be repeated to obtain the solution in \(\mathbb{R}^n\).
</p>
<h3>Step 2: Removing the curl</h3>
<p>After the initial map is found, we need to remove its curl. This is not completed in one run. Instead, we consider the map \(S:X\to X\) with \(S_{\#}\mu=\mu\) (&ldquo;measure preserving&rdquo;). This map is parametrized by time \(t\), so that it becomes a &ldquo;flow&rdquo; and will be updated as time progresses.  The map is initiated as the identity \(S(x,0)=x\), and the final goal is to let \(F_0(S^{-1}(x,t))\) converge to a curl-free mapping.
</p>
<p>Noe let's focus only on decreasing the objective function \(M\), namely
</p>
<p style="text-align:center">
\[
    M(t) = \int_{X}\|F(x, t)-x\|^2 I_0(x) \mathrm d x
\]
</p><p>We take the derivative wrt. \(t\) (for details, see [<a href="https://link.springer.com/article/10.1023/B:VISI.0000036836.66311.97" target=&ldquo;blank&rdquo;>2</a>]):
</p>
<p style="text-align:center">
\[
    \frac{\partial M}{\partial t}=-2 \int_{X}\left\langle F(x, t), I_0(\color{green}{\frac{\partial S}{\partial t} \circ S^{-1}(x, t)})\right\rangle \mathrm d x
\]
</p><p>The question is, what is \(\frac{\partial S}{\partial t}\). Recall that \(S\) should preserve the measure, i.e., \( I_0(x)=\operatorname{det}(D S(x)) I_0(S(x))\). By differentiating this equation, we have
</p>
<p style="text-align:center">
\[
\begin{equation}
\color{green}{\frac{\partial S}{\partial t}} = (\frac{1}{I_0}\xi)\color{green}{\circ S},
\label{eq:AHT-S}
\end{equation}
\]
</p><p>for some divergence-free vector field \(\xi\) on \(X\) so that \(\langle \xi,\mathbf{n}\rangle=0\) with \(\mathbf{n}\) being normal to the boundary of \(X\). Subsequently, we have
</p>
<p style="text-align:center">
\[
\frac{\partial M}{\partial t}=-2 \int_{X}\bigg\langle F(x, t), \xi(x, t)\bigg\rangle \mathrm d x.
\]
</p><p>Notice that \(\xi\) is divergence-free, and that by <a href="https://en.wikipedia.org/wiki/Helmholtz_decomposition" target=&ldquo;blank&rdquo;>Helmholtz decomposition</a> \(F=\nabla \phi+\chi\) for divergence-free field \(\chi\). Using the <a href="https://en.wikipedia.org/wiki/Divergence_theorem" target=&ldquo;blank&rdquo;>divergence theorem</a>, we can simplify the above equation
</p>
<p style="text-align:center">
\[
\frac{\partial M}{\partial t}=-2 \int_{X}\bigg\langle \chi(x, t), \xi(x, t)\bigg\rangle \mathrm d x.
\]
</p><p>Now we see that if we take \(\xi=\chi\), then \(M\) will decrease most. But how do we find \(\chi\)? One way is to first find \(\phi\) and then subtract \(\nabla \phi\) from \(F\), since finding \(\phi\) is much simpler. Using the fact that \(\chi\) is divergence-free, we take the divergence of both sides in the Helmholtz decomposition, and will have
</p>
<p style="text-align:center">
\[
\operatorname{div}(F)=\Delta \phi,
\]
</p><p>with boundary condition \(\langle\nabla \phi, \mathbf{n}\rangle=\langle F, \mathbf{n}\rangle\) on \(\partial X\). We simply write the solution for this equation as
</p>
<p style="text-align:center">
\[
\phi = \Delta^{-1}\operatorname{div}(F),
\]
</p><p>and thus \(\xi=\chi = F-\nabla \Delta^{-1}\operatorname{div}(F)\). Now, at this stage, we can precisely characterize \(S\) through \(\eqref{eq:AHT-S}\). As a consequence, through \(F(x, t)=F_0\left(S^{-1}(x, t)\right)\), we can also characterize \(F\), by
</p>
<p style="text-align:center">
\[
\frac{\partial F}{\partial t} = -\frac{1}{I_0}(DF)\xi \implies \frac{\partial F}{\partial t} =-\frac{1}{I_0}(DF)( F-\nabla \Delta^{-1}\operatorname{div}(F)).
\]
</p><p>Now, this equation can be translated into the numerical scheme as 
</p>
<p style="text-align:center">
\[
\color{blue}{F(x,t_{n+1}) = F(x,t_n) + \alpha \frac{1}{I_0}(DF)( F-\nabla \Delta^{-1}\operatorname{div}(F(x,t_n))).}
\]
</p><p>Note that there will be simpler expression in \(\mathbb{R}^2\) (see [<a href="https://link.springer.com/article/10.1023/B:VISI.0000036836.66311.97" target=&ldquo;blank&rdquo;>2</a>]).
</p>
<h2>Side notes</h2>
<h3>How are the curls removed?</h3>
<h2>Implementation</h2>
<div id="footer">
<div id="footer-text">
Page generated 2022-12-26 10:03:17 CST.
</div>
</div>
</td>
</tr>
</table>
</body>
</html>
